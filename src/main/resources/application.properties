# App
spring.application.name=planiar
# -----------------------------------------------------------------
# PLANIAR - application.properties (reorganized for merge)
# - Uses environment variables first. Defaults are safe for local dev (H2 in-memory).
# - To connect to Supabase/pgbouncer, set SPRING_DATASOURCE_URL, SPRING_DATASOURCE_USERNAME,
#   and SPRING_DATASOURCE_PASSWORD in your environment (Railway secrets).
# -----------------------------------------------------------------

# Application
spring.application.name=planiar

# -------------------------
# Datasource (env-first, safe defaults)
# -------------------------
# Prefer explicit env var SPRING_DATASOURCE_URL. If not provided the app falls back to H2 in-memory
# (safe for local development). To use Supabase/pgbouncer, set SPRING_DATASOURCE_URL to the JDBC URL
# provided by Supabase (append sslmode=require&preferQueryMode=simple if needed).
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:h2:mem:planiar;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:sa}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:}
# Driver: override with SPRING_DATASOURCE_DRIVER when connecting to Postgres (e.g. org.postgresql.Driver)
spring.datasource.driver-class-name=${SPRING_DATASOURCE_DRIVER:org.h2.Driver}

# -------------------------
# Hikari (connection pool) - conservative defaults and env overrides
# -------------------------
spring.datasource.hikari.pool-name=PlaniarHikariCP
spring.datasource.hikari.connection-timeout=${SPRING_DATASOURCE_CONNECTION_TIMEOUT:30000}
spring.datasource.hikari.idle-timeout=${SPRING_DATASOURCE_IDLE_TIMEOUT:600000}
spring.datasource.hikari.max-lifetime=${SPRING_DATASOURCE_MAX_LIFETIME:1800000}
spring.datasource.hikari.maximum-pool-size=${SPRING_DATASOURCE_MAX_POOL_SIZE:10}
spring.datasource.hikari.minimum-idle=${SPRING_DATASOURCE_MIN_IDLE:2}
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.validation-timeout=${SPRING_DATASOURCE_VALIDATION_TIMEOUT:5000}
spring.datasource.hikari.leak-detection-threshold=${SPRING_DATASOURCE_LEAK_DETECTION:0}

# -------------------------
# Supabase / pgbouncer guidance (commented, use envs)
# If you connect through Supabase session pooler (pgbouncer), recommended:
# - Use a small maximum-pool-size (e.g. 4-6)
# - Prefer simple query mode to avoid extended protocol issues: add preferQueryMode=simple to JDBC URL
# - Use sslmode=require in JDBC URL if provider requires SSL
# Example JDBC URL:
# jdbc:postgresql://aws-1-us-east-2.pooler.supabase.com:5432/postgres?sslmode=require&preferQueryMode=simple
#
# To enable session-pooler specific behavior set these env vars in Railway:
# SPRING_DATASOURCE_URL, SPRING_DATASOURCE_USERNAME, SPRING_DATASOURCE_PASSWORD
# SPRING_DATASOURCE_MAX_POOL_SIZE (e.g. 6), SPRING_DATASOURCE_PREFER_QUERY_MODE=simple

# Supabase / connection-pooler (pgbouncer) guidance
# If you plan to connect to Supabase (Postgres) through the session pooler
# use a small pool size and prefer the simple query protocol. Set the
# JDBC URL to the Supabase connection string (the one Supabase provides)
# and add `preferQueryMode=simple` and `sslmode=require` if needed.
# Example JDBC URL (recommended):
# jdbc:postgresql://db.xxxxxx.supabase.co:5432/postgres?sslmode=require&preferQueryMode=simple
#
# Recommended env variables for Supabase deployments (set these in Railway):
# - SPRING_DATASOURCE_URL -> the JDBC URL provided by Supabase (see example above)
# - SPRING_DATASOURCE_USERNAME
# - SPRING_DATASOURCE_PASSWORD (mark as secret)
# - SPRING_DATASOURCE_DRIVER (org.postgresql.Driver)
# - SPRING_DATASOURCE_MAX_POOL_SIZE (override below if needed)
#
# Hikari tuning more conservative for Supabase / pgbouncer:
spring.datasource.hikari.maximum-pool-size=${SPRING_DATASOURCE_MAX_POOL_SIZE:6}
spring.datasource.hikari.minimum-idle=${SPRING_DATASOURCE_MIN_IDLE:1}
# Test query to validate connections
spring.datasource.hikari.connection-test-query=SELECT 1
# Prefer simple query mode when connecting through pgbouncer (transaction pooling)
spring.datasource.hikari.data-source-properties.preferQueryMode=${SPRING_DATASOURCE_PREFER_QUERY_MODE:simple}
# Some environments need a shorter validation timeout
spring.datasource.hikari.validation-timeout=${SPRING_DATASOURCE_VALIDATION_TIMEOUT:5000}
# Leak detection (ms). Set to 0 to disable
spring.datasource.hikari.leak-detection-threshold=${SPRING_DATASOURCE_LEAK_DETECTION:2000}
# -------------------------------------------------------------

# JPA / Hibernate
# -------------------------
# JPA / Hibernate
# -------------------------
# Control SQL logging and DDL strategy via env vars. Defaults are safe for local dev.
spring.jpa.show-sql=${SPRING_JPA_SHOW_SQL:false}
spring.jpa.properties.hibernate.format_sql=${SPRING_JPA_FORMAT_SQL:true}
# DDL auto: 'validate' recommended for prod; default 'update' helps local dev but use with caution
spring.jpa.hibernate.ddl-auto=${SPRING_JPA_HIBERNATE_DDL_AUTO:update}
# Dialect: leave empty for auto-detection; set SPRING_HIBERNATE_DIALECT in prod if necessary
spring.jpa.properties.hibernate.dialect=${SPRING_HIBERNATE_DIALECT:}

# Flyway migrations: controllable via env var SPRING_FLYWAY_ENABLED
# Default to false to avoid startup failures on DB versions not yet supported by the bundled Flyway.
# Set SPRING_FLYWAY_ENABLED=true in production once Flyway version compatibility is confirmed.
# Flyway migrations: controllable via env var SPRING_FLYWAY_ENABLED (default false to avoid compatibility issues)
spring.flyway.enabled=${SPRING_FLYWAY_ENABLED:false}

# Actuator (debug/health)
management.endpoints.web.exposure.include=health,info,metrics,loggers
management.endpoint.health.show-details=always
management.server.port=8080

# Logging tuning (can be overridden via SPRING_APPLICATION_JSON or LOGGING_LEVEL_* vars)
logging.level.org.hibernate.SQL=${LOGGING_LEVEL_ORG_HIBERNATE_SQL:WARN}
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=${LOGGING_LEVEL_ORG_HIBERNATE_BINDER:ERROR}


